## 第七章

- 网络安全
    - 网络安全概论
        - 网络安全
            - Cyber Security 是指网络系统的硬件、软件及其系统中的数据受到保护，不因偶然的或恶意的原因而遭受到破坏、更改、泄露，系统连续可靠正常地运行，网络服务不中断
        - 计算机网络面临的威胁主要分为两大类
            - 主动攻击
                - 主动地去做一些在网络基础上的恶意行为：恶意篡改信息数据、发布恶意程序脚本等
                - 篡改
                - 恶意程序
                - 拒绝服务
            - 被动攻击
                - 被动攻击主要是收集信息而不是访问，不改变数据本身的结构，也不对软硬件数据造成影响
                - 截取
                - 截获
                - 窃取
                - 流量分析
        - 网络系统的特性
            - 保密性
                - 信息不泄露给非授权用户、实体或过程，或供其利用
            - 完整性
                - 数据未经授权不能进行改变，即信息在存储或传输过程中保持不被修改、不被破坏和丢失
            - 可用性
                - **可被授权实体访问并按需求使用。**即当需要时能否存取所需的信息。例如网络环境下拒绝服务、破坏网络和有关系统的正常运行等都属于对可用性的攻击
            - 可靠性
                - 对信息的传播及内容具有控制能力
            - 不可抵赖性
                - 出现安全问题时提供依据与手段



- 加密和互交
    - 加密和解密
        - 加密
            - 是以某种特殊的算法改变原有的信息数据，使得未授权的用户即使获得了已加密的信息，但因为不知道解密的方法，仍然无法了解信息的内容
                - 加密手段
                    - MD5加密（信息-摘要算法）
                        - 128位
                    - AES加密（对称密钥加密）
                        - 128、192、256位
                    - SHA1加密（安全哈希算法）
                        - 160位
                    - RSA加密`*`
                        - 公钥加密、私钥加密
                            - 1024位
            - 解密
                - 加密的逆过程就是解密
        - 公钥和私钥
            - 对称加密
                - 加密机制的组成元素
                    - 算法
                        - 将普通的信息或可以理解的信息与一串数字(密钥)结合，产生不可理解的密文
                    - 密钥
                        - 用来对数据进行编码和解密的一串数字
                - 对加密机制的要求
                    - 1.必须提供高度的安全性
                    - 2.具有相当高的复杂性，使得破译的开销超过获得的利益，但同时又便于理解和掌握
                    - 3，安全性应当不依赖于算法的保密，加密的安全性仅以加密密钥的保密为基础
                    - 4.必须适合不同的用户和不同的应用场合
                    - 5.实现算法的电子器件必须很经济，运行有效
                - 常见加密算法
                    - 经典算法
                        - DES算法
                            - ![](711a7c0d-6278-4118-bb7b-54c95719be15_1.webp)DES 是以 64 位的明文为一个单位进行加密的，由于每次**只能加密 64 位的数据**，如果加密的明文比较长，就需要对 DES 加密进行迭代
                            - **DES 的基本结构称为费斯妥结构（Feistel structure）**。在费斯妥结构中, 加密的各个步骤称为**轮（round）**，整个加密过程就是进行若干次轮的循环。DES 是一种*16轮*循环的费斯妥结构
                            - 一轮的具体步骤![](1c9a7e0e-fc14-487d-bc47-8cb7d133eeec_1.webp)
                                - 1.将输入的数据等分为左右两部分
                                - 2. 将输入的右侧直接发送到输出的右侧
                                - 3.将输入的右侧发送到轮函数
                                - 4.费斯妥函数（F函数）根据右侧数据和本轮中加密所使用的密钥（称为**子密钥**），得到二进制数据
                                - 5.将上一步得到的二进制数据与左侧数据进行异或（XOR）运算，并将结果作为解密后的左侧
                                - 再与原本的半块**组合并交换顺序**，进入下一个回次的处理
                            - ![](55b3d4a2-3603-4794-8bf1-405ef7579967_1.webp)**费斯妥函数（F函数）,每次对半块（32位）进行操作，包括四个步骤**
                                - 扩张 用扩张置换（图中的E）将32位的半块扩展到48位，其输出包括8个6位的块，每块包含4位对应的输入位，加上两个邻接的块中紧邻的位。
                                - 与密钥混合 用异或操作将扩张的结果和一个子密钥进行混合。16个48位的子密钥—每个用于一个回次的F变换—是利用密钥调度从主密钥生成的（见下文）。
                                - S盒 在与子密钥混合之后，块被分成8个6位的块，然后使用“S盒”，或称“置换盒”进行处理。8个S盒的每一个都使用以查找表方式提供的非线性的变换将它的6个输入位变成4个输出位。S盒提供了DES的核心安全性—如果没有S盒，密码会是线性的，很容易破解。
                                - 置换 最后，S盒的32个输出位利用固定的置换，“P置换”进行重组。这个设计是为了将每个S盒的4位输出在下一回次的扩张后，使用4个不同的S盒进行处理。
                        - 3DES
                            - 相当于是对**每个数据块应用三次资料加密标准（DES）算法**
                            - 3DES使用“密钥包”，其包含3个DES密钥，K1，K2和K3，均为56位（除去奇偶校验位）
                            - 加密
                                - ![](c18f3443145f460ea81649ce08cc4012_1.jpg)使用 K1 为密钥进行 DES 加密，再用 K2 为密钥进行 DES “解密”，最后以 K3 进行 DES 加密
                            - 解密
                                - ![](04af8c5c01f949b48f1585aa3088ceeb_1.jpg) K3 解密，以 K2 “加密”，最后以 K1 解密
                        - AES
                            - 也是由多个轮（round）所构成，但是没使用*费斯妥结构*，而是使用了 **代码-置换网络（简称 SPN）**。 轮函数任务就是根据密钥编排序列（即轮密码）对数据进行不同的代换及置换等操作
                            - AES加密过程是在一个4×4的字节矩阵上运作，这个矩阵又称为**体（state）**，其初值就是一个明文区块（矩阵中一个元素大小就是明文区块中的一个Byte）
                            - 加密时，各轮AES加密循环（除初始轮和最后一轮）均包含4个步骤
                    - 现代算法
                        - 块加密
                            - **分组密码**是每次只能处理特定长度的一块数据的一类密码算法，这里的“一块”就称为**分组**。此外，一个分组的位数就称为**分组长度**。例如，DES 分组长度为 64 位，AES 的分组长度可以为 128位、192位 和 256位
                            - 分组算法只能加密固定长度的分组，但是明文的长度一般要远大于分组大小，这时就需要对分组密码算法进行迭代，而迭代的方法就称为分组的**模式**
                                - 电子密码本：Electronic Code Book Mode (ECB)
                                    - ECB 模式只是将明文按分组大小切分，然后用同样的密钥正常加密切分好的明文分组
                                - 密码分组链接：Cipher Block Chaining Mode (CBC)
                                - 密文反馈：Cipher Feedback Mode (CFB)
                                - 输出反馈：Output Feedback Mode (OFB)
                                - 计数器模式：Counter Mode (CTR)
                - 采用单钥密码系统的加密方法，同一个密钥同时用作信息的加密和解密，也叫单密钥加密
            - 非对称加密（安全性更高）
                - 使用非对称的加密方式时，会生成两把钥匙。发送方利用自己的公钥加密，接收方利用自己的私钥解密。
                - RSA密钥生成过程
                    - 数论知识
                        - 同余：如果两个整数a和b满足a-b能被m整除，即(a-b)modm=0，那么就称整数a与b对模m同余，记作a≡b(modm)，同时可成立amodm=b
                        - 欧拉函数：任意给定正整数n，计算在小于等于n的正整数之中，**有多少个与n构成互质关系**？计算这个值的方法就叫做欧拉函数，以φ(n)表示
                        - 如果n可以分解成两个互质的整数之积，即n=p×q，则有：φ(n)=φ(pq)=φ(p)φ(q)
                            - 根据“大数是质数的两个数一定是互质数”可以知道：一个数如果是质数，则小于它的所有正整数与它都是互质数；所以如果一个数p是质数，则有：φ(p)=p-1
                            - 若我们知道一个数n可以分解为两个**质数**p和q的乘积，则有φ(n)=(p-1)(q-1)
                        - 欧拉定理：如果两个正整数a和n互质，则n的欧拉函数φ(n)可以让下面的等式成立![](cc5b23bf-679f-4deb-b848-1ca9b1f3bdf1_1.webp)
                        - 模反元素：![](307b06fe-4a0c-4c2d-beb8-9d5b1f7a8acf_1.webp)如果两个正整数a和n互质，那么一定可以找到整数b使得ab-1被n整除，或者说ab被n除的余数是1
                            - 如果b是a的模反元素，则 b+kn 都是a的模反元素
                    - 计算过程
                        - 1.随机选择两个不相等的质数p和q（乙选择了61和53）
                        - 2.计算p和q的乘积n=p×q=61×53=3233
                        - 3.根据本文“欧拉函数”介绍过的公式φ(n)=(p-1)(q-1)代入计算n的欧拉函数值φ(3233)=(61-1)×(53-1)=60×52=3120
                        - 4.随机选择一个整数e，条件是1\<e\<φ(n)，且e与φ(n)互质。乙就在1到3120之间，随机选择了17
                        - 5.因为e与φ(n)互质，根据求模反元素的公式计算e，对于e的模反元素d有：ed≡1(modφ(n))这个式子等价于(ed-1)/φ(n)=k（k为任意正整数）即ed-kφ(n)=1，代入数据得：17d-3120k=1实质上就是对以上这个二元一次方程求解得到一组解为：(d,k)=(2753,-15)
                        - 6.将n和e封装成公钥，n和d封装成私钥n=3233，e=17，d=2753所以公钥就是(3233,17)，私钥就是(3233,2753)
                - RSA加密和解密计算过程
                    - 加密：m是原文，c是密文
                        - ![](22f263d3-ac8f-40bc-bdee-2b0912a7ed3e_1.webp)
                    - 解密：m是原文，c是密文
                        - ![](83947034-4a14-4527-8565-6055da826d6c_1.webp)
        - 防火墙
            - ![](3beb1e3f-218d-4423-b594-9284b0fefbcd_1.webp)
            - 防火墙是一种访问控制技术，可以严格控制进出网络边界的分组，禁止任何不必要的通信，来减少前在入侵的发生。它是一种位于内部网络与外部网络之间的网络安全系统。是一项信息安全的防护系统，依照特定的规则，允许或是限制传输的数据通过。
            - 防火墙的区域
                - Local本地地域
                    - 顶级安全区域，安全优先级为100
                    - Local就是防火墙本身的区域比如ping指令等网际控制协议的回复，需要local域的权限凡是由防火墙主动发出的报文均可认为是从local区域中发出是需要防火墙响应并处理（而不是转发）的报文均可认为是Local区域接收
            - 原理：
                - ![](55460639-f5ed-4a9b-bc7c-719f0f2eb94a_1.jpg)
                - 包过滤（Packet filtering）：工作在网络层，仅根据数据包头中的IP地址、端口号、协议类型等标志确定是否允许数据包通过。
                - 应用代理（Application Proxy）：工作在应用层，通过编写不同的应用代理程序，实现对应用层数据的检测和分析。
                - 状态检测（Stateful Inspection）：工作在2~4层，访问控制方式与1同，但处理的对象不是单个数据包，而是整个连接，通过规则表和连接状态表，综合判断是否允许数据包通过。
                - 完全内容检测（Compelete Content Inspection）：工作在2~7层，不仅分析数据包头信息、状态信息，而且对应用层协议进行还原和内容分析，有效防范混合型安全威胁。
            - Trust受信区
                - 高级安全区域，安全优先级为85
                - 通常用来定义内部用户所在的网络，也可以理解为应该是防护最严密的地区
            - DMZ非军事化区
                - 中级安全区域，安全优先级50
                    - 通常用来定义内部服务器所在网络
                    - 作用是把WEB。E-mail等允许外部访问的服务器单独接在该区域端口，使整个需要访问，实现内外网分离，达到用户需求。DMZ可以理解为一个不同于外网或内网的特殊网络区域，DMZ内通常放置一些不含机密信息的公用服务器，比如Web，Mail，FTP中的服务。这样来自外网的访问者可以访问DMZ中服务，但不可能接触到存放在内网中的公司机密或私人信息等，及时DMZ中服务器受到破坏，也不会对内网中的机密信造成影响
                - Untrust非受信区
                    - 低级安全区域，安全优先级为5
                    - 通常用来定义Internet等不安全的网络，用于网络入口线的接入。
        - 报文鉴别与散列函数
            - 当我们传送不需要加密的报文时，应当使接收者能用很简单的方法鉴别报文的真伪（数字签名需要长时间运算）
            - 报文鉴别的可能方式和要求
                - 报文摘要 MD(Message Digest)
                    - A 将报文 X 经过报文摘要算法运算后得出很短的报文摘要 H。然后然后用自己的私钥对 H 进行 D 运算，即进行数字签名。得出已签名的报文摘要 D(H)后，并将其追加在报文 X 后面发送给 B。B 收到报文后首先把已签名的 D(H) 和报文 X 分离。然后再做两件事。(1) 用A的公钥对 D(H) 进行E运算，得出报文摘要 H 。(2) 对报文 X 进行报文摘要运算，看是否能够得出同样的报文摘要 H。如一样，就能以极高的概率断定收到的报文是 A 产生的。否则就不是
                - 实体鉴别
                    - 实体鉴别是在系统接入的全部持续时间内对和自己通信的对方实体只需验证一次
                        - 最简单的实体鉴别：A 发送给 B 的报文的被加密，使用的是对称密钥 KAB。B 收到此报文后，用共享对称密钥 KAB进行解密，因而鉴别了实体 A 的身份
                        - 重放攻击：入侵者 C 可以从网络上截获 A 发给 B 的报文。C 并不需要破译这个报文（因为这可能很花很多时间）而可以直接把这个由 A 加密的报文发送给 B，使 B 误认为 C 就是 A。然后 B 就向伪装是 A 的 C 发送应发给 A 的报文
                            - 不重数解决：不重数就是一个不重复使用的大随机数，即“一次一数”
                            - 中间人攻击说明A 向 B 发送“我是 A”的报文，并给出了自己的身份。此报文被“中间人” C 截获，C 把此报文原封不动地转发给 B。B 选择一个不重数 RB 发送给 A，但同样被 C 截获后也照样转发给 A。中间人 C 用自己的私钥 SKC 对 RB 加密后发回给 B，使 B 误以为是 A 发来的。A 收到 RB 后也用自己的私钥 SKA 对 RB 加密后发回给 B，中途被 C 截获并丢弃。B 向 A 索取其公钥，此报文被 C截获后转发给 A。C 把自己的公钥 PKC冒充是 A 的发送给 B，而 C 也截获到 A 发送给 B 的公钥 PKA。B 用收到的公钥 PKC（以为是 A 的）对数据加密发送给 A。C 截获后用自己的私钥 SKC 解密，复制一份留下，再用 A 的公钥 PKA对数据加密后发送给 A。A 收到数据后，用自己的私钥 SKA 解密，以为和B进行了保密通信。其实，B发送给A的加密数据已被中间人 C 截获并解密了一份。但 A 和 B 却都不知道。
        - 公钥系统
            - 公钥加密机制的组成元素
                - 公钥、私钥
            - 加密与数字签名
                - 数字签名：是只有信息的发送者才能产生的别人无法伪造的一段数字串，这段数字串同时也是对信息的发送者发送信息真实性的一个有效证明。（将信息类比与人，那么数字签名的作用就类似于身份证。用于对消息的发送者身份及内容的确认） 所以数字签名有两个作用，一个是对消息发送者身份的确认 二是对消息内容未被篡改的确认 
                    - 生成：对要传输的消息原文使用消息摘要算法（MD5 / SHA）生成消息摘要，发送方使用自己的私钥对消息摘要进行加密后生成数字签名。
                    - 验证：数字签名同摘要一同传送给接收方，接收方使用发送方的公钥解密数字签名还原消息摘要，并对消息原文使用相同的消息摘要算法（MD5 / SHA）计算出消息摘要，将这两个消息摘要进行对比，如果不同则说明消息在传输过程中被篡改过。
                - 数字签名的四大特点
                    - 防止重放攻击
                        - 攻击者利用网络监听或则其他方式盗取认证凭据，之后再把它重新发给认证服务器。在数字签名中，如果采用了对签名报文加盖时间戳等或添加流水号等技术，就可以有效防止重放攻击
                    - 防止数据伪造
                        - 其他人不能伪造对消息的签名，因为私有秘钥只能签名者自己知道，所有其他人不可以构造出正确的签名结果数据
                    - 防止数据被篡改
                        - 数字签名与原始文件或摘要一起发送给接受者，一旦信息被篡改，接受者可以通过计算摘要和验证签名来判断该文件无效，从而保证了文件的完整性
                    - 防止数据抵赖
                        - 数字签名既可以作为身份认证的依据，也可以作为签名者签名操作的证据。要防止接受者抵赖，可以在数字签名系统中要求接收者返回一个自己的签名的表示收到报文，给发送者或者信任第三方。如果接受者不返回任何信息，此次通信可终止或重新的开始，签名方也没有任何的损失，由此双方均不可抵赖
            - Diffie-Hellman密钥交换过程
                - **是一种安全交换密钥的方法，可以让双方在不泄漏密钥的情况下，得出一个密钥**
                    - **Diffie-Hellman密钥交换方法在发送和接收双方间建立了一个“秘密通信方法”，目的是为了能够在公共平台发送秘密数据**
                    - 请注意，**如果Diffie-Hellman密钥交换使用与我们示例中的数字一样小，则不安全**
                - 1.Alice和Bob首先相互决定从两个数字开始，模量（p）和基数（g）。在实际使用中，模量（p）是一个非常大的素数，而基数（g）相对较小，以简化计算。基数（g）来自一个循环群（G），该循环群通常在其他步骤发生之前就生成。
                - 2.Alice为自己确定了一个秘密号码（a），而Bob则选择自己的秘密号码（b）。
                - 3.然后，爱丽丝执行以下计算，给她将发送给鲍勃的号码：A = g^a mod p。当我们为鲍勃做同样的事情时，我们会得到：B= g^b mod p
                - 4.然后，爱丽丝把她的结果（A）发给鲍勃，而鲍勃把他的数字（B）发给爱丽丝。
                - 5.然后，爱丽丝使用她从鲍勃（B）那里收到的数字和她的秘密号码（a）来计算共享秘密s，使用以下公式：s = B^a mod p;鲍勃执行本质上相同的计算，s= A^b mod p 
                - 6.双方最终都获得了s的相同结果。这是共同的秘密，只有爱丽丝和鲍勃知道。然后，他们可以用它来设置对称加密的密钥，允许他们以只有他们才能访问的方式在自己之间安全地发送信息。
                - 注意:尽管B和s在上面的例子中是相同的，但这只是基于为本插图选择的小数字的巧合。通常，在Diffie-Hellman密钥交换的实际实现中，这些值将不同。尽管上述大部分数据以明文（p、g、A和B）通过通道发送，并且可以被潜在的攻击者读取，但共享密钥（s）永远不会传输。对于攻击者来说，从以明文发送的信息中计算共享秘密（s）或秘密数字（a和b）是不切实际的。**当然，这假设Diffie-Hellman密钥交换已正确实现，并使用了足够大的数字**。只要遵守这些规定，Diffie-Hellman密钥交换就被认为是建立共享秘密的安全方法，可用于确保未来的通信。
            - 数字证书（DC）的概念和构造,CA（证书认证中心）
                - 数字证书：数字签名依赖于发送方公钥的安全性，如何确保公钥来自真实的发送方而非仿造？这就需要依赖于数字证书。
                    - 生成：1.申请者（即之前所说的消息发送方）将自己的公钥、身份信息等按照 CA 中心要求提交；  2.CA 中心在认证通过后，将申请者的公钥、身份信息和证书有效期等信息合并作为证书原文 `O`  3.CA 中心对证书原文 `O` 执行 Hash 运算得到摘要 `H`；  4.CA 中心使用自己的私钥对摘要 `H` 进行加密得到签名信息 `S`；  5.CA 中心将 `O` 和 `S` 合并成一个文件，这个文件就是数字证书 `DC`
                    - 接收方收到数字证书后使用 CA 中心的公钥对签名信息 `S` 进行解密得到摘要 `H`，然后对证书原文 `O` 执行相同的 Hash 运算得到摘要 `h`，通过 `H` 和 `h` 的对比可以判断证书内容的真实性和完整性。如果证书原文中的公钥和身份信息都是 CA 中心的，说明是 CA 自签名。
                - CA：数字证书认证机构（Certificate Authority，缩写为CA），是负责发放和管理数字证书的权威机构，并作为受信任的第三方，承担公钥体系中 **公钥合法性检验** 的责任。CA 中心为每个使用公开密钥的用户发放一个数字证书，数字证书的作用是证明证书中列出的用户合法拥有证书中列出的公开密钥。全球权威的 CA 中心的证书已被各软件厂商设置为 **可信任的根证书**。所谓 **根证书** 是指此证书是受信任的起始点，可以使用此证书来证明其它证书。这些证书被预置到软件内的过程是未知的，这也是最关键的安全环节。
                    - 防止攻击，在公钥交换的时候
            - 安全电子邮件系统设计
        - 网络各层的安全协议
            - SSL（TLS）
                - 安全[套接字](https://so.csdn.net/so/search?q=%E5%A5%97%E6%8E%A5%E5%AD%97&amp;spm=1001.2101.3001.7020)层（SSL，Secure Sockets Layer)是基于公钥密码体制和X.509数字证书技术，为网络通信提供身份认证以及数据传输保密性、完整性的一种安全协议。
                - ![](9e7db20d-ee7f-4370-905f-67f1c71b9b38_1.jpg)SSL/TLS是位于传输层与应用层之间的加密协议（属于Socket层实现），对于应用层来说是透明的，应用层数据通过传递给SSL层进行加密，并增加SSL头，再传递给传输层。
                - 组成
                    - 握手协议：协商加密算法、MAC算法以及会话密钥
                        - 建立安全能力、服务端认证和密钥交换、客户端认证和密钥交换、完成握手
                    - 警报协议：当客户机和服务器发现错误时，会向对方发送一个警报消息。如果是致命错误，算法立即终止会话并关闭SSL连接，同时删除相关会话记录、秘密和密钥。
                    - 记录协议：客户端和服务端完成鉴别并确定安全信息交换使用的算法后，进入SSL记录协议，主要提供两个服务:
                        - 数据保密性:使用握手协议定义的秘密密钥对传送的数据加密。
                        - 消息完整性:使用握手协议定义的带有MAC的密钥计算消息认证码。
                        - 记录协议接收到应用程序传送的消息，将数据分片(切成容易管理的小区块)，然后选择是否对这些区块作压缩，再加上此区块的消息认证码，将数据区块与MAC一起做加密处理，加上SSL记录头后通过TCP传送出去。接收数据方对数据进行解密、验证、解压缩、重组，将消息的内容还原，传送给上层应用程序。
                - IPSEC：VPN，隧道协议
                    - IPsec的主要功能是建立安全的隧道，在隧道中传输的数据是加密的，可以保护数据的完整性和安全性。它还可以防止数据泄露，阻止数据篡改，以及实现认证和数据流量控制等功能。
                    - VPN隧道技术是一种把内网中的数据通过安全可靠的通道发送到外网中去的技术。它可以帮助用户安全地使用网络，同时也可以使用户更好地访问到其他网络中的资源。
                - WiFi
                - 防火墙：基本概念和原理

