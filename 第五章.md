## 第五章

- 传输层
    - 传输层概论
        - 传输层
            - 提供端到端的服务：**编址、复用、流控制、面向连接、可靠传输**
            - 从通信和信息处理的角度看，传输层向上层应用层提供通信服务
            - 所谓的端口号，就像门牌号。客户端可以通过IP地址找到对应的服务器端，**服务器端有很多个端口，每个应用程序对应一个端口号**，通过端口号客户端才能真正的访问到该服务器。
        - 端口号
            - FTP：21（20）
                - 文件传输协议
                - 21连接；20传数据
            - TELNET：23`*`
                - 远程登录
            - SMTP：25`*`
                - SMTP（电子邮件传输协议）
                - POP3（邮局协议版本3）：110
            - DNS：53`*`
                - 域名系统
            - TFTP：69
                - 简单文件传输协议
            - HTTP：80`*`
                - 超文本传输协议
            - SNMP：161
                - 简单网络管理协议
            - HTTPS：443`*`
                - 超文本传输安全协议
    - 可靠传输协议的设计
        - 数据包损坏：校验和，ACK，NAK信号
            - 校验和：检测冲突？溢出的话回卷 需要校验的部分16位每份，依次二进制反码求和，得到结果放入校验和字段
            - ACK：接收方收到了数据报回发告知
            - NAK：接收方没收到数据报回发高中
            - 如果ACK/NAK出错？引入新的序号机制，发送方在每个分组加入序号，如果ACK/NAK出错，就重传当前分组，接收方丢弃重复分组
            - 停等协议：发送方发送一个分组，然后等待接收方的应答
        - 数据包丢失：超时计时器
        - 按序交付、副本检测：以序列号区分，要求序列号空间足够大
        - 传输效率：流水线协议
    - 流水线协议
        - 流水线：允许传输多个包，序列号要求升序，在接收者和发送者方都要有缓冲区
        - 滑动窗口
            - 发送窗口：发送缓冲区的大小：一次最多可以发送多少个未经确认的分组
            - 接收窗口：接收窗口的大小决定发送窗口的大小；存在”未接收并未准备接收“，但不存在”已接收未回复ACK“
        - 接收方如何发送ACK？
            - Cumulative：累计确认，即发送ACK时只用发送最后一个消息的ACK即可，连续片段。
            - Selective：允许TCP单独确认非连续的片段。
        - 流水线差错恢复协议（重发）
            - 回退N步 Go-Back N（**GBN**）
                - 接收端发送累计型确认，如果不连续则不确认；如果接收窗口尺寸=1只接受顺序，不接受乱序
                - 发送端设定**一个**最老的未确定分组的定时器，到时间重传所有未确认分组
            - 选择重传（SR）
                - 接收端对每个分组单独确认；窗口尺寸\>1可以乱序
                - 发送方为**每个**未确认分组都设置一个定时器
    - 传输层的两个重要协议
        - TCP比UDP可靠，但传输效率不如
        - *TCP*：传输控制协议，是TCP/IP体系中较为复杂的协议，是传输层中最重要的协议（像电路交换，有连接）
            - 基本服务：TCP协议是一个**面向连接的、可靠的传输协议**，它提供一种可靠的字节流，能保证数据完整、无损并且按顺序到达。TCP尽量连续不断地测试网络的负载并且控制发送数据的速度以避免网络过载。另外，TCP试图将数据按照规定的顺序发送。
            - 协议首部格式：源端口(4个字节)、目的端口(4)、序**号seq(4)：报文段首字节在字节流的编号、确认号ack(4)：期望从另一方收到的下一个字节的序号（累计确认）**、数据偏移(4)、保留(4)、控制位(8)、窗口、检验和(2)、紧急指针(16)
            - 流量控制
                - 滑动窗口rwnd机制的设计
                - 信用量窗口
                - TCP复合的窗口管理方式
                    - 基于接收方缓冲区、基本机制和工作流程：接收方控制发送方，不让发送方发送太多导致接收缓冲区溢出：接收方在其向发送方的TCP段头部的rwnd字段通告其空闲buffer的大小
            - 连接维护
                - 建立：三次握手
                    - ![](6917bb65-4d2d-4dec-96ce-3d5ab6901559_1.png)
                    - ACK：TCP首部的标志位。**TCP规定，在连接建立后，所有传送的报文段必须把ACK置1**
                    - 同步**SYN**：在建立连接时用来同步序号。当SYN=1且ACK=0时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使SYN=1且ACK=1。
                    - 必要性：是为了在建立连接的时候，**避免重复连接，防止旧的重复连接引发连接混乱问题，通过三次握手可以得到一个确认的可靠初始序列号seq**，两次握手不行，并且三次握手也是最节省资源的连接方式。
                - 终止：四次挥手
                    - ![](9cbb36f3-90ec-4abe-92bf-3a4f6daba919_1.png)
                    - 第一次挥手：客户端请求断开连接，向服务器发送一个数据包，首部格式内容为FIN=1,ACK=0
                    - 第二次挥手：服务器收到后，给客户端发一个数据包，首部格式内容为FIN=0,ACK=1（第二次挥手后服务器还可以向客户进行数据传送）
                    - 第三次挥手：服务器请求断开连接，给客户端发送一个数据包，首部格式内容FIN=1,ACK1
                    - 第四次挥手：客户端收到后，向服务器发送一个确认的数据包，首部格式内容为FIN=0, ACK=1
            - 拥塞控制算法
                - 时延RTT估计算法
                    - RTT：一个数据包从发出去到回来的时间
                    - SampleRTT：**就是从某报文段交给IP到该报文段的确认被收到之间的时间量**。TCP会为一个**已发送但目前尚未被确认**的报文段估计SampleRTT，绝对**不会为已被重传的报文段**计算SampleRTT。
                    - EstimatedRTT：TCP维持的SampleRTT加权平均值
                        - 如果a很接近0，新的样本影响不大；如果a很接近1，新的样本影响较大
                        - EstimatedRTT = (1 - a)`*` 旧的EstimatedRTT + a `*` 新的SampleRTT（推荐a = 0.125)
                    - DevRTT：RTT偏差的加权平均
                        - RTTd1 = RTTs1/2
                        - 新的RTTd = （1-b）`*`旧的RTTD + b`*`| RTTs - 新的RTT样本 |
                        - 推荐b=0.25
                    - 超时重传时间RTO = RTTs+4`*`RTTd
                - RTO计时器管理算法
                    - TCP对每个连接维护一个超时定时器
                    - **出现超时重传时，新的RTO=两倍旧的RTO**
                - Jacobson‘s Reno
                    - 发送方维护一个叫做拥塞窗口cwnd的状态变量，其值取决于网络的拥塞程度并且动态变化
                        - 维护原则：只要没有出现拥塞，拥塞窗口增大；出现拥塞，拥塞窗口减小
                        - 怎么判断网络是否拥塞：发生超时重传
                    - 发送方将拥塞窗口cwnd作为发送窗口swnd
                    - 慢启动（一开始向网络注入的报文段少）
                        - 维护一个开始门限ssthresh(阈值)状态变量
                            - 当cwnd\<ssthresh：使用**慢开始算法，按传输轮次指数级增长cwnd**；
                            - cwnd\>ssthresh：停止使用慢开始，而改用拥塞避免算法
                            - =：都可以
                    - 拥塞避免
                        - 并非完全避免拥塞，在阶段截断线性（增1）增长cwnd，使网络比较不容易拥塞
                    - **重传计数器超时，判断网络可能出现了拥塞，则将ssthresh更新为拥塞时cwnd值的一半，将cwnd减到1，重新开始慢开始算法**
                    - 快重传
                        - 情况：报文段丢失但网络并没有拥塞，发送方会误以为拥塞而将cwnd减为1开始慢开始，**降低了传输效率**
                        - 采用快重传让发送方尽可能早知道发生了个别报文段的丢失
                        - 原理：尽快进行重传而不是等超时计时器超时再重传
                            - 要求接收方立刻发送确认
                            - 即使收到失序报文段也要立即发出对“已收到报文段”的重复确认
                            - **发送方一旦收到3个连续的重复确认，就立即重传相应报文段**
                - 快恢复
                    - 发送方一旦收到3个连续的重复确认，知道时丢失了个别报文段，不启用慢开始，启用快恢复
                    - 流程：发送方将慢开始门限和cwnd都调整为当前窗口值的一半，开始执行拥塞避免算法
                        - *也有的算法是将cwnd增大一些，=更新后的ssthresh（cwnd的一半）+3*
            - TCP的主要特点：
                - 1.**面向连接的传输层协议**
                - 2.提供可靠的交付服务
                - 3.提供全双工通信
                - 4.面向字节流
            - 窗口
                - 固定窗口
                    - 如果窗口过小，当传输比较大的数据时需要不停的对数据进行确认，会造成很大的延迟
                - 滑动窗口
                    - 滑动窗口是一种流量控制技术。本质上时描述接收方的TCP数据报缓冲区大小的数据，发送方根据这个数据来计算自己最多能发送多长的数据，如果发送方收到接收方的窗口大小为0的TCP数据报，那么发送方将停止发送数据，等到接收方发送窗口大小不为0的数据报的到来
                - 拥塞处理和流量控制
        - *UDP*：更像分组交换
            - 用户数据报协议：UDP
            - UDP在IP数据报服务之上增加了一些功能:复用和分用、差错检测
                - UDP报文段：源端口号、目的端口号、长度、**校验和**、应用程序数据（报文）
            - UDP的主要特点：
                - 1.**无连接**，简单（发送端和接收端没有连接状态）
                - 2.尽最大努力交付，**不可靠**
                - 3.面向报文且没有拥塞控制和流量控制
                - 4.开销较小、传输效率较高
            - 应用：流媒体（丢失不敏感，速率敏感、应用可控制传输速率）
            - UDP首部的概念
    - 数据网络中的拥塞控制
        - 拥塞问题
            - 分组丢失（路由器缓冲区溢出）
            - 分组经历比较长的延迟（在路由器的队列中排队）
        - 网络拥塞和性能指标
        - 拥塞情况下网络吞吐率特征：下降
        - 拥塞控制方式
            - 抑制分组：ICMP通知源节点
            - 反压：要求每一跳减少运输
            - 警告位：报头一个bit，通过ACK传回去
            - 随机早期丢弃（RED）
            - 公平队列
                - Max-Min fairness：
                    - 要点：如果你的需求没有被满足，那么没有人比你得到更多
                    - 步骤：先把C/N分配给需求最小的用户，这可能超出了他的需求，**将超出部分回收**，再将(C-C1)/(N-1)分给需求次小的用户...依次重复上述过程，**直到某一次分给用户的资源不能满足用户。此时将剩余的资源平分给剩下的人。**
                - Fair Queuing：对于每个数据包，计算数据包的最后一位离开路由器的时间，然后**按照截止时间的递增顺序**提供服务
    - 网络服务质量
        - 不同类型应用对QoS要求：弹性流量和非弹性流量
        - 综合服务体系（ISA）
            - RSVP协议
            - 优先级排队，使用资源预留协议RSVP让每个路由器预留带宽，为流建立软状态
        - 区分服务（DS）
            - 将流量划分成类，利用服务级别协议SLA对不同DS字段的流量不同处理





- *流量调度算法：漏桶机制和令牌桶机制*
    - 漏桶机制：让数据包以固定速率出缓冲区
        - 漏桶算法思路很简单，请求先进入到漏桶里，漏桶以固定的速度出水，也就是处理请求，当水加的过快，则会直接溢出，也就是拒绝请求，可以看出**漏桶算法能强行限制数据的传输速率**。
        - 对于很多场景来说，除了要求能够限制数据的平均传输速率外，**还要求允许某种程度的突发传输**。这时候漏桶算法可能就不合适了，令牌桶算法更为适合。
    - 令牌桶机制：每个时间片恒定掉令牌。若令牌桶最大容量为b个令牌，每秒生成r个令牌，那么在长度为t的时间内，数据包量≤rt+b
        - 令牌桶算法是网络流量整形和速率限制中最常使用的一种算法。典型情况下，令牌桶算法用来控制发送到网络上的数据的数目，并允许突发数据的发送。
        - 大小固定的令牌桶可自行以恒定的速率源源不断地产生令牌。如果令牌不被消耗，或者被消耗的速度小于产生的速度，令牌就会不断地增多，直到把桶填满。后面再产生的令牌就会从桶中溢出。最后桶中可以保存的最大令牌数永远不会超过桶的大小。
        - 传送到令牌桶的数据包需要消耗令牌。不同大小的数据包，消耗的令牌数量不一样。令牌桶这种控制机制基于令牌桶中是否存在令牌来指示什么时候可以发送流量。令牌桶中的每一个令牌都代表一个字节。如果令牌桶中存在令牌，则允许发送流量；而如果令牌桶中不存在令牌，则不允许发送流量。
        - 因此，如果突发门限被合理地配置并且令牌桶中有足够的令牌，那么流量就可以以峰值速率发送。





