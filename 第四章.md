## 第四章

- 网络层
    - 网络层的作用（单位分组）
        - 提供端到端的服务
            - 网络层的目的是实现两个端系统之间的数据透明传送，具体功能包括**寻址、转发和路由选择、连接的建立（虚电路）**、保持和终止等。它提供的服务使传输层不需要了解网络中的数据传输和交换技术
            - **路由：**当数据包到达路由器的输入链路时，路由器会将数据包移动到路由器的输出链路。
            - 虚电路建立连接：虚电路的所有分组**要通过的一系列链路与路由器**。网络层也为沿着该路径的每条链路确定一个 VC 号。在沿着路径的每台路由器的转发表中增加一表项。在虚电路建立期间，网络层还可以预留虚电路路径上的资源(如带宽)。
    - 网际层IP协议：IP协议是TCP/IP协议的核心，所有的TCP，UDP，IMCP，IGCP的数据都以IP数据格式传输。IP协议不可靠（没有提供未到达处理办法）。
        - IP基本原理：IP 协议把上层数据报封装成 IP 数据报后进行传输，如果 IP 数据报太大，还要对数据报进行分片后再传输，到了目的地址处再进行组装还原，以适应不同物理网络对一次所能传输数据大小的要求。
        - 异构网络环境下，internet协议的工作过程
        - 协议
            - 协议原语与相关参数
            - IPv4首部格式
                - ![](d4745353-cc29-40e6-9ef9-0d6280ed3b0c_1.png)
                - 载荷长度：总长度-IHLx4byte
            - ARP地址解析协议
                - 通过IP地址获得物理地址
                - 原理：
                - 流程
            - RARP反地址解析协议
            - ICMP网际控制报文协议
                - 通过ICMP传输控制消息
                    - 控制消息：网络通不通、主机是否可达、路由是否可用等网络本身的消息，如ping
                - ping和traceroute的实现原理
                    - ping:**Ping 会发送 **`echo request message`** 到某个地址，然后等待应（reply），当 echo request 到达目标地址以后，在一个有效的时间内（timeout 之前）返回 echo reply message 给源地址，则说明目的地可达。如在有效时间内，没有收到回应，则在发送端显示超时。**Ping 命令是把 ICMP 报文中的**标示符**置为发送该 ICMP 报文的进程，这样在对端可以区分出从本端运行的多个 Ping 实例。Ping 命令每发送一个 ICMP 回显请求报文，顺序号就加 1，顺序号从 1 开始，不同的系统发送回显请求的数量不同，默认情况发送 5 个回显请求报文。也可以通过命令行参数设 置发送回显请求报文的个数，如果对端可达，则在对端会相应回应 5 个和请求端同样序号的 ICMP 回应报文。
                    - traceroute:源端首先发送 3 个 TTL 字段的值都为 1 的 UDP 数据报给远程设备，使用随机的任何大于 32768 的端口地址作为目标设备的接受报文端口，TTL 为1的数据报到达第一跳路由器以后随即超时，路由器响应源设备一个 ICMP 的超时报文，之后源端再发送3个 UDP 数据报，这次更改 TTL 值为 2，即经过 2 个路由器以后，响应源端 tICMP 超时报文，依次类推，直到这些 UDP 报文到达了目标设备。由于发送的报文中的目的端口，目标设备接收到 ICMP 报文后，**由于报文的端口是一个在目标设备没有使用的端口，目标设备就会响应 ICMP port unreachable 信息给源端，表示目标端口不可达，同时说明 Tracert 执行完毕。**从而可以从源端显示的结果中，看到到目标设备所经过的路径。**Tracert 发送数据报的 TTL 值最大可以到 30，每一次发送如果在指定的时间的内没有回应报文，在发送端就会显示超时，如果发送 30 跳的g值后，仍然显示为超时，表明无法达到目标设备，测试失败。**默认情况没有发送报文的超时时间为 5 秒，可以在 0ms～65535ms 之 间进行设置。
            - IGMP网际组管理协议
                - 是用于管理网路协议**多播**组员的一种通信协议
                - IP主机和相邻的路由器利用IGMP来创建多播组的组成员。组播方式解决了单播情况下数据的重复拷贝及带宽的重复占用，也解决了广播方式下带宽资源的浪费
    - *IP地址*
        - IP地址的概念
            - IP地址
                - IP地址是IP协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异
            - 组成
                - 4个字节，32位组成，一般用点分十进制的方式表达
                    - 0.0.0.0、128.0.0.0
            - IP地址和MAC地址的区别
                - 1.IP地址是逻辑地址，MAC地址是物理地址
                - 2.MAC地址唯一，IP地址不唯一
                - 3.MAC地址主要工作在第二层，IP地址在网络层
                - 4.MAC地址48位，IP地址一般是32位（v6是128位）
                - 5.IP地址的分配取决于网络拓扑，MAC地址分配取决于制造商
        - IP地址的组成
            - **由主机地址和网络地址组成**
            - 主机地址/主机号
                - 标识某一台设备的地址
            - 网络地址/网络号
                - 标识某一个网段的地址
            - 子网掩码
                - 作用：**用于区分网络号和主机号**
                    - 用来指明一个IP地址的哪些位标识的是主机所在的子网，哪些位标识的是主机的位掩码。子网掩码不能单独存在，必须结合IP地址一起使用
                - 是网络号的比特全为1
        - IP地址的分类
            - A类
                - 第一个字节为网络号，**第一个字节第一位是0**
                    - A类地址网络数量较少，有127（2^7-1）个网络，每个网络可以容纳主机1600多万台
                    - 1.0.0.1 到 127.255.255.254
                    - 子网掩码是255.0.0.0
            - B类
                - 前两个字节为网络号，**第一个字节字节前两位是10**
                - 适用于中等规模的网络，有16384个网络，每个网络能容纳主机6万多台
                - 128.0.0.1 到 191.255.255.254
                - 子网掩码是255.255.0.0
            - C类
                - 前三个字节为网络号，**第一个字节字节前三位是110**
                - 网络地址数较多，有209万余个网络，适用于小规模局域网络，每个网络最多只能包含256台计算机
                - 192.0.0.1到223.255.255.254
                - 子网掩码是255.255.255.0
            - D类
                - **最高位必须是1110**
                - 在历史上被叫做多播地址，即组播地址。在以太网中，多播地址命名了一组应该在这个网络中应用接收到一个分组的站点。
                - 224.0.0.0到239.255.255.255
            - E类
                - **最高位必须是1111**
                - 保留
            - 特殊地址
                - 网络地址
                    - 主机号为全0的地址不可用
                - 广播地址
                    - 主机号为全1的地址
                - 回环地址
                    - 127.0.0.0
        - IPv6
            - IPv4地址满足不了需求，出现匮乏的情况，所以诞生了IPv6继续使用。v6地址由128位，16个字节组成，一般表现形式为十六进制。
    - *子网划分*
        - 子网划分
            - 概念：用于减少地址浪费，将一个大的有类网络，划分成若干个小的子网，使得IP地址的使用更加科学
            - 通过修改子网掩码，起到更精细划分网络号和主机号的作用
        - VLSM（Variable Length Subnet Mask）
            - 可变长子网掩码，是为了有效的使用无类别域间路由（CIDR）和路由汇聚（route summary）来控制路由表的大小，它是网络管理员常用的IP寻址技术，可以对子网进行层次化编址，以便最有效的利用现有的地址空间
        - 给你iP地址和子网掩码，求网段
    - *子网聚集*
    - 分组交换网络
        - 路由器是实现分组交换的关键构建。其任务是转发收到的分组。这是网络核心部分最重要的功能。
        - 基本思想
            - 分组交换采用**存储转发技术**。把一个报文划分为几个分组后再进行传送。通常，我们把要发送的整块数据成为一个报文。在发送报文之前，先把一个报文划分为一个个更小的等长数据段。每一个数据包前面，加上一些由必要的控制信息组成的**首部(header)**后，就构成了一个分组（packet)。**分组的首部包含了诸如目的地址和源地址等重要的控制信息。**凭借这些信息，每一个分组可以在互联网中**独立地选择传输路径，并被正确地交付到分组传输的终点**。
    - 分组基本交换网络中的路由
        - 路由
            - 路由是什么？
                - 路由（routing）是指分组从源到目的地时，决定端到端路径的网络范围的进程。路由是指报文转发的路径信息，通过路由可以确认转发IP报文的路径。
                    - 路由时网络层最主要的工作任务
            - 路由器
                - 网络层的基本设备
                - 数据转发
                - 一个端口代表一个网段，路由器中存放着通往各个网段的表格，叫做路由表
            - 路由表
                - routing table, 或称作路由择域信息库（RIB Routing Information Base）, 是一个存储在路由器或者联网计算机中的电子表格（文件）或类数据库。
                - 路由表存储着指向特定网络地址的路径，路由表相当于一个小型数据库，实现一组目的地址到下一条路由 IP 地址的映射
            - 网关
                - Gateway，又称网间连接器、协议转换器
                - **用于两个高层协议不同的网络互联，既可以用于广域网互联，又可以用于局域网互联**
        - 性能评估指标
            - 
        - 路由信息的更新方式
            - 手工配置
            - 路由协议动态维护，路由器将基于管理距离（ Administrative Distance， AD）和路由度量（metric）选出进入路由表的最佳路径
        - 路由算法
            - 集中式路由：集中式路由选择算法（centralized routing algorithm）用完整的、全局性的网络知识计算出从源到目的地之间的**最低开销路径**
            - 分布式路由：在分散式路由选择算法（decentralized routing algorithm）中，路由器以迭代、分布式的方式计算出最低开销路径。没有节点拥有关于所有网络链路开销的完整信息。相反，每个节点仅有与其直接相连链路的开销知识即可开始工作
                - 洪泛：基本思想是每个节点都是用广播转发收到的数据分组，若收到重复分组则进行丢弃处理。需要设定合适的TTL（discarding packets）值，保证数据分组只经过有限跳路由。为了进行重复分组检测，每个节点需要维护一个数据分组序号SEQ和一张路由表，源节点每发送一个数据分组则将SEQ增1，并将该SEQ添加到数据分组的IP头部，其余节点收到数据分组后会将该SEQ记录到路由表并根据该SEQ进行重复分组检测。
                - 随机行走
                    - 从一个或一系列顶点开始遍历一张图，在任意一个顶点，遍历者将以概率1-a游走到这个顶点的邻居顶点，以概率a跳跃到图中任何一个顶点（称a为跳转发生概率）。每次游走后得到一个概率分布，刻画了图中每一个顶点被访问的概率，用这个概率分布作为下一次游走的输入反复迭代这一过程，在某种条件下这个概率会收敛，得到一个平稳的概率分布。
                - 自适应路由
                    - 与相邻路由器交换信息，优化完成
            - 最小代价路由算法及其性能分析
                - Bellman-Ford（分布式、局部信息）
                    - 算法：x到y的带权最短路径长度 = min(x的邻居v){x到v的权重+v到y的带权最短路径长度}
                        - 路径费用增加：产生无穷计数问题
                            - 毒性逆转：若节点a通过节点b到达节点c，则节点a将虚假但善意地告诉b：a到c的距离是无穷大，从而避免环路问题；
                    - 性能分析：异步迭代
                - Dijstra Algorithm（集中式、全局信息）
                    - 算法：
                    - 性能分析：存在震荡的可能
                - 第一、二、三代互联网路由算法之间的对比和改进
            - 链路代价的算法
        - 自洽系统与路由的配置方式：
            - 自洽系统：因特网将整个互联网划分为许多较小的自洽系统（一个自洽系统包括多个局域网），每个自洽系统有权决定自身内部的协议。
            - 如果两个自洽系统需要通信，则需要一个在自洽系统之间的协议屏蔽这些差异。因此因特网将路由选择协议划分为两类：
                - IRP（IGP）：内部网关协议，自洽系统内部使用的路由选择协议，包括RIP、OSPF
                - ERP（EGP）：外部网关协议，自洽系统之间使用的路由选择协议，如BGP
            - 内部路由协议
                - 距离向量协议（RIP）
                    - 是一种分布式的基于距离向量的路由选择协议，UDP，向自己的相邻结点交换自己的路由表信息。通过UDP报文发送，定期交换；路由改变；对方请求
                - 链路状态协议（OSPF）
                    - 向本自洽系统中的所有路由器发送信息，使用泛洪法（RIP仅向自己相邻的几个路由器发送信息），直接IP数据报。每当一条链路状态变化时，路由器就会广播链路状态信息；即使链路状态未发生变化，它也要周期性地广播链路状态。
                - 路由结构图与路由表的生成
            - BGP
                - BGP的功能：BGP 是不同自治系统的路由器之间交换路由信息的协议。边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。。**防环**
                - 基本报文类型和工作方式
                    - ![](b9ccea26-12a0-4a3e-a14b-016992d3f9b5_1.png)
                    - 使用 TCP 连接交换路由信息的两个 BGP 发言人， 彼此成为对方的邻站（neighbor）或对等站（peer） 
            - 静态路由
                - 静态路由（去哪个网段，往哪走）
                    - 由管理员手工配置、配置方便，对系统要求低，适用于拓扑结构简单稳定的小型网络
                - 缺省路由（不知道去哪个网段，默认走）
                    - 是一种特殊的路由，当报文没有在路由表中找到具体的匹配项时才使用的路由
            - 动态路由
                - 动态路由
                    - 通过动态路由协议来实现不同网段的路由互通
                    - 动态路由协议由自己的路由算法，能够自动适应网络拓扑的变化，适用于具有一定数量的三层设备的网络
                - 动态路由协议
                    - *RIP*
                        - RIP（路由协议信息）
                        - 基于矢量（跳数）的动态路由协议
                        - 适用于中小规模的网络拓扑，最大跳数为15
                        - 可能产生环路问题
                    - *OSPF*
                        - OSPF（开放式最短路径优先）、Dijstra算法
                        - 基于链路状态的协议
                        - 使用SPF算法，计算最短路径，树形协议，无环
                    - *BGP*
                        - 自治系统之间的路由协议
                    - IS-IS
                        - 内部网关协议
                        - Intemediate System-to-Intermediate Ststem，中间系统到中间系统。
                        - 与OSPF类似，基于路由路划分区域，OSPF利用接口划分
                    - RIP和OSPF的区别
                        - 1.RIP基于矢量，OSPF基于链路状态
                        - 2.RIP适用于中小型网络拓扑，OSPF适用于较大规模的网络
                        - `3.OSPF支持可变长度子网掩码（VLSM），RIP不支持`*不完全对*
                        - 4.OSPF的收敛速度比RIP迅速
                        - 5.OSPF防环，RIP不防环
    - CIDR表达（如12.253.96.0/18）
    - IPv6与IPv4
        - 异同
        - 优缺点
    - NAT原理及优缺点
        - **路由器对数据包进行地址转换，路由器在接收到内部数据包时将内部源IP地址转化为公有IP地址后在进行路由转发。**
        - 优点 ：NAT允许企业内部网络使用私有地址，并通过设置合法的地址集，使内部网络可以与互联网进行通信，从而达到节省合法注册地址的目的。NAT增强了内部网络与公共网络连接时的灵活性。它可以通过使用多地址集、备份地址集和负载分担/均衡地址集，来确保可靠的公网连接。
        - 缺点：NAT会使延迟增大。NAT增加了配置和配错的复杂性。使用和实施NAT时，无法实现对IP包端对端的路径跟踪。NAT也可能会使某些需要使用内嵌IP地址的应用不能正常工作，因为它隐藏了端到端的IP地址。
        - 由于NAT的采用，**我们无法再通过统计IP地址数的方式来确定连接外网的主机数量。为了解决这一问题**，相关研究人员已经设计了一系列的检测方案，对NAT后主机数量进行检测。检测方案可分为主动检测和被动检测两种。
            - 因为序列号是有序的，可以将序列号分组，有多少组就是多少个主机（估算）
            - 被动检测方法中，比较典型的有IP ID序列法、timestamp检测法以及cookie检测法。其中IP ID检测法利用某些操作系统IP报文中ID字段与所发IP报文数目同步递增的特点，通过检测网关出口流量中连续的ID序列段数目来估计主机数目。而timestamp检测法利用不同主机发出的TCP报文中timestamp字段与接收时间表现出不同的线性关系这一特点，通过计算不同的线性关系数目来估计主机数目。对于cookie检测法，则是通过提取所捕获http报文的cookie字段，统计同一网站下不同cookie的数量来估计主机数目。
    - DHCP动态地址获取过程:
        - 第一步：DHCP Client请求IP——DHCP Client 以广播的方式发出DHCP Discover报文; 
        - 第二步：DHCP server响应——DHCP Server向DHCP Client发送一个DHCP Offer报文; 
        - 第三步：DHCP Client选择IP——DHCP Client 会发出一个广播的DHCP Request报文，在选项字段中会加入选中的 DHCP Server的IP地址和需要的IP地址;
        -  第四步：DHCP server确认租约——DHCP Server向DHCP Client响应一个DHCP ACK报文，并在选项字段中增加IP地址的使用租期信息。（正式下发IP）
    - IP组播（Multicast）
        - 组播地址、组播模型、组播组管理：IGMP
        - 组播路由机制
        - Shared-tree，Source-based tree

